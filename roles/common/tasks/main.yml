---

#
# Packages required for ansible to run
# 
- name: install packages required for ansible
  yum: pkg=$item state=installed
  with_items:
    - libselinux-python

#
# ntp and timezone
# 

- name: set timezone
  template: src=clock.j2 dest=/etc/sysconfig/clock

#
# The file module refuses to create a link where a file exists, and 
# initially the /etc/localtime file is a file. So had to fall back to
# using ln -sf, which is not good. Perhaps should be creating a file 
# instead of a link here.
# 

- name: setup timezone link
  shell: ln -sf /usr/share/zoneinfo/{{timezone_country}}/{{timezone_city}} /etc/localtime
  #file: state=link src=/usr/share/zoneinfo/{{timezone_country}}/{{timezone_city}} dest=/etc/localtime

- name: install ntp package
  yum: pkg=ntp state=installed

- name: check if ntp is syncronized
  shell: ntpstat
  register: ntp_syncronized
  ignore_errors: True

- name: stop ntpd to run ntpdate
  service: name=ntpd state=stopped
  when: ntp_syncronized.rc > 0
  ignore_errors: True

- name: run ntpdate
  shell: ntpdate {{ntpdate_timeserver}}
  when: ntp_syncronized.rc > 0

- name: ensure ntp service is running and enabled
  service: name=ntpd state=started enabled=yes

#
# I was trying to use ntpstat to check if time is syncronized, but
# even after time is setup Ok with ntpdate and ntpd is running, it 
# still takes some time for the clock to line up properly. So this 
# might not work, and have commented it out for now.
#

#- name: check if ntp is syncronized again
#  shell: ntpstat
#  when: ntp_syncronized.rc > 0

#
# Disable selinux
#

- name: disable selinux  
  selinux: state=disabled

#
# Configure a custom repository at packages.serverascode.com/mrepo
# that has the vcl, vcl-web, and vcl-managementnode RPMs
#

- name: install serverascode centos 6 yum repo
  copy: src=serverascode-centos6.repo dest=/etc/yum.repos.d/serverascode-centos6.repo owner=root group=root mode=0644
  notify:
    - refresh yum cache

#
# Install rpmforge and epel repositories
#

- name: install rpmforge repository
  yum: pkg=$item state=installed
  with_items:
    - rpmforge-release
    - epel-release
  notify:
    - refresh yum cache

#
# Had issues with dhclient, so am removing it if it's there
# 

- name: uninstall dhclient if it's installed
  yum: pkg=dhclient state=removed

# 
# XXX FIX ME XXX
# Disable iptables -- ansible doesn't have a module for iptables yet, and 
# the general consensus seems to be to use templates and don't quite have
# time for that right now.

#
# Iptables
#

- name: disable iptables 
  service: name=iptables state=stopped enabled=no


 